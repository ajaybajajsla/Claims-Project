<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Claims Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Bootstrap and icons (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background:#f7f7fb; }
    .tile { border-radius:12px; padding:16px; color:#fff; cursor:pointer; }
    .tile .num { font-size:1.5rem; font-weight:700; }
    .tile .label { font-size:.9rem; opacity:.9; }
    .tile-pending { background:#6c757d; }
    .tile-wip { background:#0d6efd; }
    .tile-report-pending { background:#17a2b8; }
    .tile-generated { background:#20c997; }
    .tile-overdue { background:#dc3545; }
    .badge-status { font-size:.8rem; }
    .section-card { background:#fff; border-radius:12px; box-shadow:0 4px 18px rgba(0,0,0,.06); }
    .sticky-actions { position:sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid #eee; }
    .maxh { max-height:270px; overflow:auto; }
    .req::after { content:" *"; color:#dc3545; font-weight:700; }
    .upload-area { border:2px dashed #cfd6e1; border-radius:12px; padding:16px; background:#fafbff; }
    .small-muted { font-size:.85rem; color:#6c757d; }
    .table-sm td, .table-sm th { padding:.35rem .5rem; }
    .cursor { cursor:pointer; }
    .nav-underline .nav-link.active { font-weight:600; }
    .print-area { display:none; }
    .dep-badge { padding:.25rem .5rem; border-radius:.35rem; background:#f1f5f9; display:inline-block; font-size:.9rem; }
    @media print {
      .no-print { display:none !important; }
      .print-area { display:block !important; }
    }
    .small-btn { padding:.25rem .5rem; font-size:.8rem; }
  </style>
</head>
<body>
<div class="container py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0">Claims Manager</h4>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary btn-sm" id="btnAdmin"><i class="bi bi-gear"></i> Admin</button>
      <button class="btn btn-primary btn-sm" id="btnNewClaim"><i class="bi bi-plus-lg"></i> Add New Entry</button>
    </div>
  </div>

  <!-- Dashboard tiles -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md"><div class="tile tile-pending" data-status="Pending">
      <div class="num" id="countPending">0</div><div class="label">Pending</div></div></div>
    <div class="col-6 col-md"><div class="tile tile-wip" data-status="Work In Progress">
      <div class="num" id="countWip">0</div><div class="label">Work In Progress</div></div></div>
    <div class="col-6 col-md"><div class="tile tile-report-pending" data-status="Report Pending">
      <div class="num" id="countReportPending">0</div><div class="label">Report Pending</div></div></div>
    <div class="col-6 col-md"><div class="tile tile-generated" data-status="Generated">
      <div class="num" id="countGenerated">0</div><div class="label">Generated</div></div></div>
    <div class="col-6 col-md"><div class="tile tile-overdue" data-status="Overdue">
      <div class="num" id="countOverdue">0</div><div class="label">Overdue</div></div></div>
  </div>

  <!-- Claims list, filters -->
  <div class="section-card p-3 mb-4">
    <div class="row g-2 align-items-end">
      <div class="col-6 col-md-3">
        <label class="form-label">Status</label>
        <select class="form-select" id="fltStatus">
          <option value="">All</option>
          <option>Pending</option>
          <option>Work In Progress</option>
          <option>Report Pending</option>
          <option>Generated</option>
          <option>Overdue</option>
        </select>
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Insurer</label>
        <select class="form-select" id="fltInsurer"></select>
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Date from</label>
        <input type="date" class="form-control" id="fltDateFrom">
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Date to</label>
        <input type="date" class="form-control" id="fltDateTo">
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Vehicle No</label>
        <input type="text" class="form-control" id="fltVeh" placeholder="DLXX1234">
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Claim/Policy/Ref</label>
        <input type="text" class="form-control" id="fltText" placeholder="Search text">
      </div>
      <div class="col-12 col-md-6 d-flex gap-2">
        <button class="btn btn-secondary" id="btnClearFilters">Clear</button>
        <button class="btn btn-primary" id="btnApplyFilters"><i class="bi bi-search"></i> Search</button>
      </div>
    </div>
    <hr>
    <div class="table-responsive maxh">
      <table class="table table-sm align-middle" id="tblClaims">
        <thead class="table-light">
          <tr>
            <th>Ref</th><th>Claim No</th><th>Policy No</th><th>Insurer</th><th>Vehicle No</th><th>Date</th><th>Status</th><th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Claim File -->
  <div id="claimEditor" class="section-card mb-4" style="display:none;">
    <div class="sticky-actions p-2 d-flex justify-content-between align-items-center">
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm no-print" id="btnBack"><i class="bi bi-arrow-left"></i> Back</button>
        <span class="small-muted">Editing: <span id="editTitle"></span></span>
      </div>
      <div class="d-flex gap-2 no-print">
        <button class="btn btn-outline-primary btn-sm" id="btnSave"><i class="bi bi-save"></i> Save</button>
        <button class="btn btn-success btn-sm" id="btnGenerate"><i class="bi bi-file-earmark-text"></i> Generate</button>
        <button class="btn btn-outline-secondary btn-sm" id="btnUpload"><i class="bi bi-upload"></i> Upload</button>
        <button class="btn btn-outline-dark btn-sm" id="btnPrint"><i class="bi bi-printer"></i> Print</button>
      </div>
    </div>

    <div class="p-3">
      <ul class="nav nav-underline" id="claimTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabPolicy" type="button">Policy details</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabVehicle" type="button">Vehicle particulars</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabDriver" type="button">Driver particulars</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLoss" type="button">Loss details</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabEstimate" type="button">Estimate/Bill</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabAssessment" type="button">Loss assessment</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabReinspection" type="button">Reinspection</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabDocs" type="button">Documents & comments</button></li>
      </ul>

      <div class="tab-content pt-3">
        <!-- Policy Details -->
        <div class="tab-pane fade show active" id="tabPolicy">
          <div class="row g-3">
            <div class="col-md-2"><label class="form-label req">Reference No</label><input id="refNo" class="form-control"></div>
            <div class="col-md-2"><label class="form-label req">Claim No</label><input id="claimNo" class="form-control"></div>
            <div class="col-md-2"><label class="form-label req">Policy No</label><input id="policyNo" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Type of Policy</label><input id="policyType" class="form-control" placeholder="OD/TP/Comprehensive"></div>
            <div class="col-md-3"><label class="form-label">IDV</label><input id="idv" type="number" class="form-control" step="0.01"></div>

            <div class="col-md-3"><label class="form-label">Insurer</label><select id="insurer" class="form-select"></select></div>
            <div class="col-md-9"><label class="form-label">Insurer Address</label><input id="insurerAddress" class="form-control"></div>

            <div class="col-md-3"><label class="form-label">Survey Entrusted By</label><input id="surveyBy" class="form-control"></div>
            <div class="col-md-2"><label class="form-label">Insured Title</label><select id="insuredTitle" class="form-select"><option>Mr</option><option>Ms</option><option>Mrs</option><option>Dr</option></select></div>
            <div class="col-md-4"><label class="form-label">Insured Name</label><input id="insuredName" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">HPA</label><input id="hpa" class="form-control" placeholder="Hypothecation"></div>

            <div class="col-md-12"><label class="form-label">Insured Address</label><textarea id="insuredAddress" class="form-control" rows="2"></textarea></div>
            <div class="col-md-3"><label class="form-label">Contact No</label><input id="insuredContact" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Email</label><input id="insuredEmail" type="email" class="form-control"></div>

            <div class="col-md-3"><label class="form-label">Period of Insurance (OD) From</label><input id="odFrom" type="date" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Period of Insurance (OD) To</label><input id="odTo" type="date" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Period of Insurance (TP) From</label><input id="tpFrom" type="date" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Period of Insurance (TP) To</label><input id="tpTo" type="date" class="form-control"></div>

            <div class="col-md-3">
              <button class="btn btn-outline-secondary w-100" id="btnCopyPeriod"><i class="bi bi-arrow-down-square"></i> Copy OD to TP</button>
            </div>

            <div class="col-12">
              <div class="row g-2">
                <div class="col-md-2"><label class="form-label">EST AMOUNT</label><input id="estAmount" type="number" class="form-control" step="0.01"></div>
                <div class="col-md-2"><label class="form-label">BILL AMOUNT</label><input id="billAmount" type="number" class="form-control" step="0.01"></div>
                <div class="col-md-2"><label class="form-label">NET ASSESSED</label><input id="netAssessedFooter" type="number" class="form-control" step="0.01" readonly></div>
                <div class="col-md-2"><label class="form-label">DIFFERENCE</label><input id="differenceFooter" type="number" class="form-control" step="0.01" readonly></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vehicle Particulars -->
        <div class="tab-pane fade" id="tabVehicle">
          <div class="row g-3">
            <div class="col-md-3"><label class="form-label req">Registration No</label><input id="vehReg" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Temp Reg</label><input id="vehTempReg" class="form-control"></div>
            <div class="col-md-2"><label class="form-label">Commercial</label><div class="form-check"><input id="vehCommercial" type="checkbox" class="form-check-input"><label class="form-check-label" for="vehCommercial">Yes</label></div></div>
            <div class="col-md-4 d-flex align-items-end"><button class="btn btn-outline-secondary" id="btnScanRc"><i class="bi bi-upc-scan"></i> Scan RC</button></div>

            <div class="col-md-4"><label class="form-label">Owner Name</label><input id="ownerName" class="form-control"></div>
            <div class="col-md-2 d-flex align-items-end"><button class="btn btn-outline-secondary" id="btnCopyInsured"><i class="bi bi-clipboard"></i> Copy Insured</button></div>
            <div class="col-md-3"><label class="form-label">Date of Delivery</label><input id="dateDelivery" type="date" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Reg Valid To</label><input id="regValidTo" type="date" class="form-control"></div>

            <div class="col-md-3"><label class="form-label">Registration Authority</label><input id="regAuthority" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Chassis No</label><input id="chassisNo" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Engine No</label><input id="engineNo" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Odometer Reading</label><input id="odometer" type="number" class="form-control" step="1"></div>

            <div class="col-md-3"><label class="form-label">Make</label><input id="make" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Model</label><input id="model" class="form-control"></div>
            <div class="col-md-2"><label class="form-label">Year</label><input id="year" type="number" class="form-control" step="1"></div>
            <div class="col-md-2"><label class="form-label">Class/Body</label><input id="classBody" class="form-control"></div>
            <div class="col-md-2"><label class="form-label">Colour</label><input id="colour" class="form-control"></div>

            <div class="col-md-2"><label class="form-label">CC</label><input id="cc" type="number" class="form-control" step="1"></div>
            <div class="col-md-2"><label class="form-label">Unladen Wt</label><input id="unladen" type="number" class="form-control" step="1"></div>
            <div class="col-md-2"><label class="form-label">Laden Wt</label><input id="laden" type="number" class="form-control" step="1"></div>
            <div class="col-md-2"><label class="form-label">Seating Cap.</label><input id="seating" type="number" class="form-control" step="1"></div>
            <div class="col-md-2"><label class="form-label">Tax Paid Up To</label><input id="taxPaidTo" type="date" class="form-control"></div>

            <div class="col-md-4"><label class="form-label">Verification Status</label><input id="verification" class="form-control" placeholder="Verified/Discrepancy"></div>
            <div class="col-md-8"><label class="form-label">Pre-accident Condition</label><input id="preAccidentCond" class="form-control" placeholder="Good/Average/Poor + notes"></div>
          </div>
        </div>

        <!-- Driver Particulars -->
        <div class="tab-pane fade" id="tabDriver">
          <div class="row g-3">
            <div class="col-md-3"><label class="form-label">Driver Name</label><input id="drvName" class="form-control"></div>
            <div class="col-md-2"><label class="form-label">Relation</label><input id="drvRelation" class="form-control"></div>
            <div class="col-md-2"><label class="form-label">Mobile</label><input id="drvMobile" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">DL No</label><input id="drvDlNo" class="form-control"></div>
            <div class="col-md-2"><label class="form-label">Issuing RTO</label><input id="drvRto" class="form-control"></div>

            <div class="col-md-3"><label class="form-label">DL Issue Date</label><input id="drvIssue" type="date" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">DL Validity</label><input id="drvValid" type="date" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Badge/Transport Endorsement</label><input id="drvBadge" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Aadhar</label><input id="drvAadhar" class="form-control"></div>

            <div class="col-md-12"><label class="form-label">Remarks</label><textarea id="drvRemarks" class="form-control" rows="2"></textarea></div>
          </div>
        </div>

        <!-- Loss Details -->
        <div class="tab-pane fade" id="tabLoss">
          <div class="row g-3">
            <div class="col-md-3"><label class="form-label">Date of Loss</label><input id="lossDate" type="date" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Time of Loss</label><input id="lossTime" type="time" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Place of Loss</label><input id="lossPlace" class="form-control"></div>

            <div class="col-md-6"><label class="form-label">Cause of Loss</label><input id="lossCause" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Intimation</label><input id="lossIntimation" class="form-control" placeholder="Date/Mode"></div>

            <div class="col-md-4"><label class="form-label">FIR/PS</label><input id="lossFir" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">TP Involvement</label><input id="lossTpInv" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Inspection Remarks</label><input id="inspRemarks" class="form-control"></div>
          </div>
        </div>

        <!-- Estimate / Bill -->
        <div class="tab-pane fade" id="tabEstimate">
          <div class="row g-3">
            <div class="col-md-4"><label class="form-label">Workshop</label><input id="workshop" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Workshop GSTIN</label><input id="workshopGstin" class="form-control"></div>
            <div class="col-md-2"><label class="form-label">Estimate Date</label><input id="estimateDate" type="date" class="form-control"></div>
            <div class="col-md-2"><label class="form-label">Bill Date</label><input id="billDate" type="date" class="form-control"></div>

            <div class="col-12">
              <div class="d-flex justify-content-between">
                <h6 class="mb-0">Items</h6>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-primary btn-sm" id="btnAddItem"><i class="bi bi-plus-circle"></i> Add item</button>
                  <button class="btn btn-outline-danger btn-sm" id="btnClearItems"><i class="bi bi-trash"></i> Clear</button>
                </div>
              </div>
              <div class="table-responsive maxh mt-2">
                <table class="table table-sm" id="tblItems">
                  <thead class="table-light">
                    <tr>
                      <th>Type</th><th>Description</th><th>Qty</th><th>Rate</th><th>Amount</th><th>Tax %</th><th>Tax</th><th>Admissible</th><th></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                  <tfoot>
                    <tr><th colspan="4" class="text-end">Subtotals:</th>
                      <th id="sumAmount">0</th><th></th><th id="sumTax">0</th><th id="sumAdmissible">0</th><th></th></tr>
                  </tfoot>
                </table>
              </div>
            </div>

          </div>
        </div>

        <!-- Loss Assessment (ENHANCED) -->
        <div class="tab-pane fade" id="tabAssessment">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Vehicle Age</label>
              <div class="dep-badge" id="vehAge">--</div>
            </div>

            <div class="col-md-3">
              <label class="form-label">Depreciation Mode</label>
              <div class="d-flex gap-2">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="depMode" id="depMode_irda" value="irda" checked>
                  <label class="form-check-label" for="depMode_irda">IRDAI</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="depMode" id="depMode_zero" value="zero">
                  <label class="form-check-label" for="depMode_zero">Zero Dep</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="depMode" id="depMode_nil" value="nil">
                  <label class="form-check-label" for="depMode_nil">Nil Depreciation</label>
                </div>
              </div>
            </div>

            <div class="col-md-3">
              <label class="form-label">Add Dep (% - extra)</label>
              <div class="input-group">
                <input id="addDepPct" type="number" step="0.1" class="form-control" value="0">
                <button id="applyAddDep" class="btn btn-outline-secondary small-btn">Apply</button>
              </div>
            </div>

            <div class="col-md-3">
              <label class="form-label">Source for age</label>
              <div class="small-muted">Uses Date of Delivery / Reg date and Date of Loss</div>
            </div>

            <div class="col-12"><hr></div>

            <!-- Parts Table -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Parts Assessment (auto depreciation)</h6>
                <div>
                  <button class="btn btn-sm btn-outline-primary" id="addPartRow"><i class="bi bi-plus-lg"></i> Add Part</button>
                  <button class="btn btn-sm btn-outline-danger" id="clearParts"><i class="bi bi-trash"></i> Clear</button>
                </div>
              </div>
              <div class="table-responsive maxh">
                <table class="table table-sm table-bordered" id="partsTable">
                  <thead class="table-light">
                    <tr>
                      <th style="min-width:120px">Part Type</th><th>Description</th><th style="width:70px">Qty</th><th style="width:110px">Rate</th>
                      <th style="width:90px">Amount</th><th style="width:80px">GST%</th><th style="width:90px">Dep %</th><th style="width:110px">Dep ₹</th><th style="width:110px">Admissible</th><th></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                  <tfoot>
                    <tr>
                      <td colspan="4" class="text-end">Subtotals:</td>
                      <td id="parts_sumAmount">0</td><td></td><td id="parts_avgDepPct">0</td><td id="parts_sumDep">0</td><td id="parts_sumAdm">0</td><td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            <div class="col-12"><hr></div>

            <!-- Labour Table -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Labour Assessment (include denting/painting)</h6>
                <div>
                  <button class="btn btn-sm btn-outline-primary" id="addLabRow"><i class="bi bi-plus-lg"></i> Add Labour</button>
                  <button class="btn btn-sm btn-outline-danger" id="clearLabour"><i class="bi bi-trash"></i> Clear</button>
                </div>
              </div>
              <div class="table-responsive maxh">
                <table class="table table-sm table-bordered" id="labourTable">
                  <thead class="table-light">
                    <tr>
                      <th style="min-width:120px">Labour Type</th><th>Description</th><th style="width:70px">Qty</th><th style="width:110px">Rate</th>
                      <th style="width:90px">Amount</th><th style="width:80px">GST%</th><th style="width:110px">Admissible</th><th></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                  <tfoot>
                    <tr>
                      <td colspan="4" class="text-end">Labour Totals:</td>
                      <td id="lab_sumAmount">0</td><td id="lab_sumTax">0</td><td id="lab_sumAdm">0</td><td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            <div class="col-12"><hr></div>

            <div class="col-md-3"><label class="form-label">Betterment</label><input id="betterment" type="number" class="form-control" step="0.01" value="0"></div>
            <div class="col-md-3"><label class="form-label">Excess</label><input id="excess" type="number" class="form-control" step="0.01" value="0"></div>
            <div class="col-md-3"><label class="form-label">Salvage</label><input id="salvage" type="number" class="form-control" step="0.01" value="0"></div>
            <div class="col-md-3"><label class="form-label">Non-admissibles</label><input id="nonAdmissible" type="number" class="form-control" step="0.01" value="0"></div>

            <div class="col-12"><hr></div>

            <div class="col-md-3"><label class="form-label">Total Admissible</label><input id="totalAdmissible" type="number" class="form-control" step="0.01" readonly></div>
            <div class="col-md-3"><label class="form-label">Depreciation Total</label><input id="depreciationTotal" type="number" class="form-control" step="0.01" readonly></div>
            <div class="col-md-3"><label class="form-label">Net Assessed</label><input id="netAssessed" type="number" class="form-control" step="0.01" readonly></div>
            <div class="col-md-3"><label class="form-label">Remarks</label><input id="assessmentRemarks" class="form-control"></div>

            <div class="col-12 small-muted mt-2">Net = Total Admissible – Depreciation – Betterment – Excess – Salvage – Non-admissibles. Dep % for metal auto computed from vehicle age per IRDAI. Use Nil/Zero modes to override.</div>
          </div>
        </div>

        <!-- Reinspection -->
        <div class="tab-pane fade" id="tabReinspection">
          <div class="row g-3">
            <div class="col-md-12 d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm" id="btnAddReinsp"><i class="bi bi-plus-circle"></i> Add entry</button>
              <button class="btn btn-outline-danger btn-sm" id="btnClearReinsp"><i class="bi bi-trash"></i> Clear</button>
            </div>
            <div class="col-12">
              <div class="table-responsive maxh">
                <table class="table table-sm" id="tblReinsp">
                  <thead class="table-light">
                    <tr><th>Date</th><th>Reason</th><th>Findings</th><th>Photos</th><th></th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Documents & Comments -->
        <div class="tab-pane fade" id="tabDocs">
          <div class="row g-3">
            <div class="col-md-6">
              <h6>Checklist</h6>
              <div id="docChecklist" class="d-grid gap-2"></div>
              <div class="small-muted mt-2">Checklist depends on insurer/policy; customize in Admin.</div>
            </div>
            <div class="col-md-6">
              <h6>Uploads</h6>
              <div class="upload-area">
                <input type="file" id="fileUpload" class="form-control" multiple accept=".pdf,.jpg,.jpeg,.png" />
                <div class="small-muted mt-2">Supports PDF/JPG/PNG up to 20 MB, max 50 files/claim.</div>
              </div>
              <ul class="list-group mt-2" id="uploadList"></ul>
            </div>
            <div class="col-md-12">
              <h6>Comments</h6>
              <div class="row g-2">
                <div class="col-md-6"><label class="form-label">Public comments</label><textarea id="commentsPublic" class="form-control" rows="2"></textarea></div>
                <div class="col-md-6"><label class="form-label">Private comments</label><textarea id="commentsPrivate" class="form-control" rows="2"></textarea></div>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- tab-content -->
    </div>
  </div>

  <!-- Admin -->
  <div id="adminPanel" class="section-card p-3 mb-4" style="display:none;">
    <h5 class="mb-3">Admin configuration</h5>
    <div class="row g-3">
      <div class="col-md-4">
        <h6>Insurers</h6>
        <div class="input-group mb-2">
          <input id="newInsurer" class="form-control" placeholder="Add insurer">
          <button class="btn btn-primary" id="btnAddInsurer">Add</button>
        </div>
        <ul class="list-group" id="listInsurers"></ul>
      </div>
      <div class="col-md-4">
        <h6>Workshops</h6>
        <div class="input-group mb-2">
          <input id="newWorkshop" class="form-control" placeholder="Add workshop">
          <button class="btn btn-primary" id="btnAddWorkshop">Add</button>
        </div>
        <ul class="list-group" id="listWorkshops"></ul>
      </div>
      <div class="col-md-4">
        <h6>Depreciation & excess</h6>
        <div class="row g-2">
          <div class="col-6"><label class="form-label">Parts %</label><input id="adminDepParts" type="number" class="form-control" step="0.01" value="30"></div>
          <div class="col-6"><label class="form-label">Paint %</label><input id="adminDepPaint" type="number" class="form-control" step="0.01" value="50"></div>
          <div class="col-6"><label class="form-label">Glass %</label><input id="adminDepGlass" type="number" class="form-control" step="0.01" value="0"></div>
          <div class="col-6"><label class="form-label">Fibre %</label><input id="adminDepFibre" type="number" class="form-control" step="0.01" value="30"></div>
          <div class="col-6"><label class="form-label">Excess (₹)</label><input id="adminExcess" type="number" class="form-control" step="0.01" value="1000"></div>
        </div>
        <div class="small-muted mt-2">Defaults are editable; IRDAI-standard slabs are used for metal depreciation.</div>
      </div>
      <div class="col-md-6">
        <h6>Document checklist templates</h6>
        <div class="input-group mb-2">
          <input id="newChecklistItem" class="form-control" placeholder="Add checklist item">
          <button class="btn btn-primary" id="btnAddChecklistItem">Add</button>
        </div>
        <ul class="list-group" id="listChecklist"></ul>
      </div>
      <div class="col-md-6">
        <h6>Report template</h6>
        <textarea id="reportTemplate" class="form-control" rows="6" placeholder="HTML template with placeholders like {{claimNo}}, {{vehReg}}, {{netAssessed}}"></textarea>
        <div class="small-muted mt-2">Use placeholders to shape PDF/print output.</div>
      </div>
    </div>
    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-success" id="btnSaveAdmin"><i class="bi bi-save"></i> Save Admin</button>
      <button class="btn btn-outline-danger" id="btnResetAdmin"><i class="bi bi-arrow-counterclockwise"></i> Reset to defaults</button>
    </div>
  </div>

  <!-- Printable report -->
  <div id="printArea" class="print-area p-4">
    <div id="printContent"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* --- Existing data store and defaults (preserved) --- */
const db = {
  claims: JSON.parse(localStorage.getItem('claims') || '[]'),
  admin: JSON.parse(localStorage.getItem('admin') || '{}')
};
const defaults = {
  insurers: ['ICICI Lombard','HDFC ERGO','Bajaj Allianz','Tata AIG','New India'],
  workshops: ['ABC Motors','Sharma Auto Works','Delite Service Center'],
  dep: { parts:30, paint:50, glass:0, fibre:30, excess:1000 },
  checklist: ['Claim form','Policy copy','RC','DL','Estimate','Photos'],
  reportTemplate: `
    <h3 style="margin:0 0 8px">Survey Report</h3>
    <hr>
    <p><b>Reference:</b> {{refNo}} &nbsp; <b>Claim No:</b> {{claimNo}} &nbsp; <b>Policy No:</b> {{policyNo}}</p>
    <p><b>Insured:</b> {{insuredTitle}} {{insuredName}} &nbsp; <b>Insurer:</b> {{insurer}}</p>
    <p><b>Vehicle:</b> {{vehReg}} &nbsp; <b>Make/Model:</b> {{make}} {{model}} ({{year}})</p>
    <p><b>Loss:</b> {{lossDate}} {{lossTime}} at {{lossPlace}} &nbsp; <b>Cause:</b> {{lossCause}}</p>
    <hr>
    <p><b>Total Admissible:</b> ₹{{totalAdmissible}} &nbsp; <b>Depreciation:</b> ₹{{depreciationTotal}} &nbsp;
       <b>Betterment:</b> ₹{{betterment}} &nbsp; <b>Excess:</b> ₹{{excess}} &nbsp; <b>Salvage:</b> ₹{{salvage}}</p>
    <h4 style="margin:12px 0">Net Assessed: ₹{{netAssessed}}</h4>
    <p><b>Remarks:</b> {{assessmentRemarks}}</p>
    <hr>
    <small>Generated on {{generatedOn}}</small>
  `
};

/* State */
let currentClaimId = null;

/* Helpers */
function saveDb() {
  localStorage.setItem('claims', JSON.stringify(db.claims));
  localStorage.setItem('admin', JSON.stringify(db.admin));
}
function initAdminDefaults() {
  if (!db.admin.insurers) db.admin.insurers = [...defaults.insurers];
  if (!db.admin.workshops) db.admin.workshops = [...defaults.workshops];
  if (!db.admin.dep) db.admin.dep = {...defaults.dep};
  if (!db.admin.checklist) db.admin.checklist = [...defaults.checklist];
  if (!db.admin.reportTemplate) db.admin.reportTemplate = defaults.reportTemplate;
  saveDb();
}
function fmt(n){ return (Number(n||0)).toFixed(2); }
function today(){ return new Date().toISOString().slice(0,10); }
function uid(){ return 'C'+Math.random().toString(36).slice(2,9); }
function getClaim(id){ return db.claims.find(c=>c.id===id); }
function ensureDepToFields() {
  document.getElementById('depParts').value = db.admin.dep.parts;
  document.getElementById('depPaint').value = db.admin.dep.paint;
  document.getElementById('depGlass').value = db.admin.dep.glass;
  document.getElementById('depFibre').value = db.admin.dep.fibre;
  document.getElementById('excess').value = db.admin.dep.excess;
}

/* IRDAI-style metal depreciation by vehicle age (months) */
function vehicleAgeMonthsFromDates(regDateStr, lossDateStr) {
  if (!regDateStr || !lossDateStr) return null;
  const reg = new Date(regDateStr);
  const loss = new Date(lossDateStr);
  if (isNaN(reg) || isNaN(loss) || loss < reg) return 0;
  const yrs = loss.getFullYear() - reg.getFullYear();
  const months = loss.getMonth() - reg.getMonth();
  const days = loss.getDate() - reg.getDate();
  let totalMonths = yrs*12 + months;
  if (days < 0) totalMonths -= 1;
  // add fractional month
  const adj = new Date(reg);
  adj.setMonth(adj.getMonth() + totalMonths);
  const extraDays = (loss - adj) / (1000*60*60*24);
  const frac = Math.max(0, extraDays) / 30.4375;
  const monthsPrecise = Math.max(0, totalMonths + frac);
  return Math.round(monthsPrecise * 100) / 100;
}
function metalDepByAgeMonths(months) {
  // Adapted IRDA-ish slabs (replace with exact IRDA table if required)
  if (months === null) return 0;
  if (months <= 6) return 5;
  if (months <= 12) return 10;
  if (months <= 24) return 15;
  if (months <= 36) return 25;
  if (months <= 48) return 35;
  if (months <= 60) return 40;
  return 50;
}

/* UI elements */
const els = {
  counts: {
    Pending: document.getElementById('countPending'),
    'Work In Progress': document.getElementById('countWip'),
    'Report Pending': document.getElementById('countReportPending'),
    Generated: document.getElementById('countGenerated'),
    Overdue: document.getElementById('countOverdue')
  },
  tblClaimsBody: document.querySelector('#tblClaims tbody'),
  claimEditor: document.getElementById('claimEditor'),
  adminPanel: document.getElementById('adminPanel'),
  printArea: document.getElementById('printArea'),
  printContent: document.getElementById('printContent'),
  insurerSelects: [document.getElementById('insurer'), document.getElementById('fltInsurer')],
  checklistContainer: document.getElementById('docChecklist'),
  uploadList: document.getElementById('uploadList'),
  fileUpload: document.getElementById('fileUpload'),
  partsTableBody: document.querySelector('#partsTable tbody'),
  labourTableBody: document.querySelector('#labourTable tbody')
};

/* Render functions (preserve original behavior) */
function renderTiles() {
  const counts = { 'Pending':0, 'Work In Progress':0, 'Report Pending':0, 'Generated':0, 'Overdue':0 };
  db.claims.forEach(c=> counts[c.status] = (counts[c.status]||0) + 1 );
  Object.keys(counts).forEach(k=> els.counts[k].textContent = counts[k] || 0);
}
function matchesFilters(c){
  const st = document.getElementById('fltStatus').value;
  const ins = document.getElementById('fltInsurer').value;
  const df = document.getElementById('fltDateFrom').value;
  const dt = document.getElementById('fltDateTo').value;
  const veh = document.getElementById('fltVeh').value.trim().toLowerCase();
  const tx = document.getElementById('fltText').value.trim().toLowerCase();
  if (st && c.status!==st) return false;
  if (ins && c.policy.insurer!==ins) return false;
  if (df && c.createdAt < df) return false;
  if (dt && c.createdAt > dt) return false;
  if (veh && !(c.vehicle.vehReg||'').toLowerCase().includes(veh)) return false;
  if (tx) {
    const blob = [c.policy.refNo,c.policy.claimNo,c.policy.policyNo].join(' ').toLowerCase();
    if (!blob.includes(tx)) return false;
  }
  return true;
}
function renderList() {
  const rows = db.claims.filter(matchesFilters).map(c => `
    <tr>
      <td>${c.policy.refNo||''}</td>
      <td>${c.policy.claimNo||''}</td>
      <td>${c.policy.policyNo||''}</td>
      <td>${c.policy.insurer||''}</td>
      <td>${c.vehicle.vehReg||''}</td>
      <td>${c.createdAt||''}</td>
      <td><span class="badge bg-secondary badge-status">${c.status}</span></td>
      <td class="text-end">
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-primary" onclick="openClaim('${c.id}')"><i class="bi bi-pencil"></i> Open/Edit</button>
          <button class="btn btn-outline-dark" onclick="printClaim('${c.id}')"><i class="bi bi-printer"></i> Print</button>
          <button class="btn btn-outline-secondary" onclick="uploadStub('${c.id}')"><i class="bi bi-upload"></i> Upload</button>
        </div>
      </td>
    </tr>
  `).join('');
  els.tblClaimsBody.innerHTML = rows || `<tr><td colspan="8" class="text-center text-muted">No claims found</td></tr>`;
}

/* Admin lists */
function renderAdminLists() {
  // Insurers
  const liIns = db.admin.insurers.map((n,i)=> `<li class="list-group-item d-flex justify-content-between align-items-center">
    ${n} <button class="btn btn-sm btn-outline-danger" onclick="delInsurer(${i})"><i class="bi bi-x-lg"></i></button>
  </li>`).join('');
  document.getElementById('listInsurers').innerHTML = liIns || '<li class="list-group-item text-muted">None</li>';
  // Workshops
  const liWs = db.admin.workshops.map((n,i)=> `<li class="list-group-item d-flex justify-content-between align-items-center">
    ${n} <button class="btn btn-sm btn-outline-danger" onclick="delWorkshop(${i})"><i class="bi bi-x-lg"></i></button>
  </li>`).join('');
  document.getElementById('listWorkshops').innerHTML = liWs || '<li class="list-group-item text-muted">None</li>';
  // Checklist
  const liCl = db.admin.checklist.map((n,i)=> `<li class="list-group-item d-flex justify-content-between align-items-center">
    ${n} <button class="btn btn-sm btn-outline-danger" onclick="delChecklist(${i})"><i class="bi bi-x-lg"></i></button>
  </li>`).join('');
  document.getElementById('listChecklist').innerHTML = liCl || '<li class="list-group-item text-muted">None</li>';
  // Dep fields
  document.getElementById('adminDepParts').value = db.admin.dep.parts;
  document.getElementById('adminDepPaint').value = db.admin.dep.paint;
  document.getElementById('adminDepGlass').value = db.admin.dep.glass;
  document.getElementById('adminDepFibre').value = db.admin.dep.fibre;
  document.getElementById('adminExcess').value = db.admin.dep.excess;
  // Template
  document.getElementById('reportTemplate').value = db.admin.reportTemplate;
  // Insurer selects
  els.insurerSelects.forEach(sel=>{
    sel.innerHTML = `<option value="">Select</option>` + db.admin.insurers.map(n=> `<option>${n}</option>`).join('');
  });
  // Checklist in claim
  els.checklistContainer.innerHTML = db.admin.checklist.map((n,i)=> `
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="chk_${i}">
      <label class="form-check-label" for="chk_${i}">${n}</label>
    </div>
  `).join('');
}
function delInsurer(i){ db.admin.insurers.splice(i,1); saveDb(); renderAdminLists(); }
function delWorkshop(i){ db.admin.workshops.splice(i,1); saveDb(); renderAdminLists(); }
function delChecklist(i){ db.admin.checklist.splice(i,1); saveDb(); renderAdminLists(); }

/* New claim */
function newClaim() {
  const id = uid();
  const claim = {
    id, status: 'Pending', createdAt: today(),
    policy: {}, vehicle: {}, driver: {}, loss: {},
    items: [], assessment: {}, reinspections: [], uploads: [], comments: {}
  };
  db.claims.unshift(claim);
  saveDb();
  openClaim(id);
}

/* Open claim editor */
function openClaim(id) {
  currentClaimId = id;
  const c = getClaim(id);
  if (!c) return;
  document.getElementById('editTitle').textContent = `${c.policy.claimNo||'(no claim no)'} | ${c.vehicle.vehReg||'(no reg)'}`;
  els.adminPanel.style.display = 'none';
  document.getElementById('claimEditor').style.display = 'block';
  // load fields
  setVal('refNo', c.policy.refNo);
  setVal('claimNo', c.policy.claimNo);
  setVal('policyNo', c.policy.policyNo);
  setVal('policyType', c.policy.policyType);
  setVal('idv', c.policy.idv);
  setVal('insurer', c.policy.insurer);
  setVal('insurerAddress', c.policy.insurerAddress);
  setVal('surveyBy', c.policy.surveyBy);
  setVal('insuredTitle', c.policy.insuredTitle || 'Mr');
  setVal('insuredName', c.policy.insuredName);
  setVal('hpa', c.policy.hpa);
  setVal('insuredAddress', c.policy.insuredAddress);
  setVal('insuredContact', c.policy.insuredContact);
  setVal('insuredEmail', c.policy.insuredEmail);
  setVal('odFrom', c.policy.odFrom);
  setVal('odTo', c.policy.odTo);
  setVal('tpFrom', c.policy.tpFrom);
  setVal('tpTo', c.policy.tpTo);
  setVal('estAmount', c.policy.estAmount);
  setVal('billAmount', c.policy.billAmount);

  setVal('vehReg', c.vehicle.vehReg);
  setVal('vehTempReg', c.vehicle.vehTempReg);
  document.getElementById('vehCommercial').checked = !!c.vehicle.vehCommercial;
  setVal('ownerName', c.vehicle.ownerName);
  setVal('dateDelivery', c.vehicle.dateDelivery);
  setVal('regValidTo', c.vehicle.regValidTo);
  setVal('regAuthority', c.vehicle.regAuthority);
  setVal('chassisNo', c.vehicle.chassisNo);
  setVal('engineNo', c.vehicle.engineNo);
  setVal('odometer', c.vehicle.odometer);
  setVal('make', c.vehicle.make);
  setVal('model', c.vehicle.model);
  setVal('year', c.vehicle.year);
  setVal('classBody', c.vehicle.classBody);
  setVal('colour', c.vehicle.colour);
  setVal('cc', c.vehicle.cc);
  setVal('unladen', c.vehicle.unladen);
  setVal('laden', c.vehicle.laden);
  setVal('seating', c.vehicle.seating);
  setVal('taxPaidTo', c.vehicle.taxPaidTo);
  setVal('verification', c.vehicle.verification);
  setVal('preAccidentCond', c.vehicle.preAccidentCond);

  setVal('drvName', c.driver.drvName);
  setVal('drvRelation', c.driver.drvRelation);
  setVal('drvMobile', c.driver.drvMobile);
  setVal('drvDlNo', c.driver.drvDlNo);
  setVal('drvRto', c.driver.drvRto);
  setVal('drvIssue', c.driver.drvIssue);
  setVal('drvValid', c.driver.drvValid);
  setVal('drvBadge', c.driver.drvBadge);
  setVal('drvAadhar', c.driver.drvAadhar);
  setVal('drvRemarks', c.driver.drvRemarks);

  setVal('lossDate', c.loss.lossDate);
  setVal('lossTime', c.loss.lossTime);
  setVal('lossPlace', c.loss.lossPlace);
  setVal('lossCause', c.loss.lossCause);
  setVal('lossIntimation', c.loss.lossIntimation);
  setVal('lossFir', c.loss.lossFir);
  setVal('lossTpInv', c.loss.lossTpInv);
  setVal('inspRemarks', c.loss.inspRemarks);

  ensureDepToFields();
  setVal('betterment', c.assessment.betterment || 0);
  setVal('excess', c.assessment.excess ?? db.admin.dep.excess);
  setVal('salvage', c.assessment.salvage || 0);
  setVal('nonAdmissible', c.assessment.nonAdmissible || 0);
  setVal('assessmentRemarks', c.assessment.remarks);

  // render estimate items (existing)
  renderItems(c.items);
  // render parts table (from claim.assessment.parts if exists)
  renderPartsTable(c.assessment.parts || []);
  renderLabourTable(c.assessment.labour || []);
  renderReinsp(c.reinspections);
  renderUploads(c.uploads);
  recomputeTotals();
  recomputeAssessment(); // new assessment calc
}

/* Set/get helpers */
function val(id){ return document.getElementById(id).value; }
function setVal(id, v){ document.getElementById(id).value = v ?? ''; }

/* Save claim */
function saveClaim() {
  const c = getClaim(currentClaimId);
  if (!c) return;
  c.policy = {
    refNo: val('refNo'), claimNo: val('claimNo'), policyNo: val('policyNo'),
    policyType: val('policyType'), idv: Number(val('idv')||0),
    insurer: val('insurer'), insurerAddress: val('insurerAddress'),
    surveyBy: val('surveyBy'), insuredTitle: val('insuredTitle'), insuredName: val('insuredName'),
    hpa: val('hpa'), insuredAddress: val('insuredAddress'), insuredContact: val('insuredContact'),
    insuredEmail: val('insuredEmail'), odFrom: val('odFrom'), odTo: val('odTo'),
    tpFrom: val('tpFrom'), tpTo: val('tpTo'),
    estAmount: Number(val('estAmount')||0), billAmount: Number(val('billAmount')||0)
  };
  c.vehicle = {
    vehReg: val('vehReg'), vehTempReg: val('vehTempReg'), vehCommercial: document.getElementById('vehCommercial').checked,
    ownerName: val('ownerName'), dateDelivery: val('dateDelivery'), regValidTo: val('regValidTo'),
    regAuthority: val('regAuthority'), chassisNo: val('chassisNo'), engineNo: val('engineNo'),
    odometer: Number(val('odometer')||0), make: val('make'), model: val('model'), year: Number(val('year')||0),
    classBody: val('classBody'), colour: val('colour'), cc: Number(val('cc')||0),
    unladen: Number(val('unladen')||0), laden: Number(val('laden')||0), seating: Number(val('seating')||0),
    taxPaidTo: val('taxPaidTo'), verification: val('verification'), preAccidentCond: val('preAccidentCond')
  };
  c.driver = {
    drvName: val('drvName'), drvRelation: val('drvRelation'), drvMobile: val('drvMobile'),
    drvDlNo: val('drvDlNo'), drvRto: val('drvRto'), drvIssue: val('drvIssue'),
    drvValid: val('drvValid'), drvBadge: val('drvBadge'), drvAadhar: val('drvAadhar'), drvRemarks: val('drvRemarks')
  };
  c.loss = {
    lossDate: val('lossDate'), lossTime: val('lossTime'), lossPlace: val('lossPlace'),
    lossCause: val('lossCause'), lossIntimation: val('lossIntimation'),
    lossFir: val('lossFir'), lossTpInv: val('lossTpInv'), inspRemarks: val('inspRemarks')
  };

  // Collect assessment parts and labour into claim.assessment
  c.assessment = c.assessment || {};
  c.assessment.depMode = document.querySelector('input[name="depMode"]:checked')?.value || 'irda';
  c.assessment.addDepPct = Number(val('addDepPct')||0);
  c.assessment.parts = readPartsTable();
  c.assessment.labour = readLabourTable();
  c.assessment.betterment = Number(val('betterment')||0);
  c.assessment.excess = Number(val('excess')||0);
  c.assessment.salvage = Number(val('salvage')||0);
  c.assessment.nonAdmissible = Number(val('nonAdmissible')||0);
  c.assessment.totalAdmissible = Number(document.getElementById('totalAdmissible').value||0);
  c.assessment.depreciationTotal = Number(document.getElementById('depreciationTotal').value||0);
  c.assessment.netAssessed = Number(document.getElementById('netAssessed').value||0);
  c.assessment.remarks = val('assessmentRemarks');

  c.items = c.items || []; // preserve estimate items (already updated on item edits)
  c.reinspections = c.reinspections || [];
  c.uploads = c.uploads || [];
  c.comments = { public: val('commentsPublic'), private: val('commentsPrivate') };
  saveDb();
  renderTiles();
  renderList();
}

/* Items table (kept same) */
function renderItems(items){
  const tbody = document.querySelector('#tblItems tbody');
  tbody.innerHTML = items.map((it, i)=> `
    <tr>
      <td><select class="form-select form-select-sm" onchange="updateItem(${i}, 'type', this.value)">
        <option ${it.type==='part'?'selected':''} value="part">Part</option>
        <option ${it.type==='labour'?'selected':''} value="labour">Labour</option>
        <option ${it.type==='paint'?'selected':''} value="paint">Paint</option>
        <option ${it.type==='consumable'?'selected':''} value="consumable">Consumable</option>
        <option ${it.type==='glass'?'selected':''} value="glass">Glass</option>
        <option ${it.type==='fibre'?'selected':''} value="fibre">Fibre</option>
      </select></td>
      <td><input class="form-control form-control-sm" value="${escapeHtml(it.desc||'')}" onchange="updateItem(${i}, 'desc', this.value)"></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm" value="${it.qty||1}" onchange="updateItem(${i}, 'qty', Number(this.value||1))"></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm" value="${it.rate||0}" onchange="updateItem(${i}, 'rate', Number(this.value||0))"></td>
      <td>${fmt(it.amount||0)}</td>
      <td><input type="number" step="0.01" class="form-control form-control-sm" value="${it.taxPct||0}" onchange="updateItem(${i}, 'taxPct', Number(this.value||0))"></td>
      <td>${fmt(it.tax||0)}</td>
      <td>${fmt(it.admissible||0)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${i})"><i class="bi bi-x-lg"></i></button>
      </td>
    </tr>
  `).join('');
  recomputeTotals();
}
function addItem(){
  const c = getClaim(currentClaimId);
  c.items.push({ type:'part', desc:'', qty:1, rate:0, taxPct:0, amount:0, tax:0, admissible:0 });
  saveDb();
  renderItems(c.items);
}
function clearItems(){
  const c = getClaim(currentClaimId);
  c.items = [];
  saveDb();
  renderItems(c.items);
}
function updateItem(i, field, value){
  const c = getClaim(currentClaimId);
  const it = c.items[i];
  it[field] = value;
  it.amount = Number(it.qty||0) * Number(it.rate||0);
  it.tax = it.amount * Number(it.taxPct||0) / 100;
  // Depreciation by type (basic fallback, overridden by assessment parts table)
  const depPct = ({
    part: Number(val('depParts')||0),
    paint: Number(val('depPaint')||0),
    glass: Number(val('depGlass')||0),
    fibre: Number(val('depFibre')||0),
    labour: 0,
    consumable: 0
  })[it.type] || 0;
  const depAmt = it.amount * depPct / 100;
  it.admissible = Math.max(0, it.amount - depAmt) + it.tax;
  saveDb();
  renderItems(c.items);
}
function removeItem(i){
  const c = getClaim(currentClaimId);
  c.items.splice(i,1);
  saveDb();
  renderItems(c.items);
}

/* Totals & assessment logic (modified) */
function recomputeTotals(){
  const c = getClaim(currentClaimId);
  if (!c) return;
  // sums
  const sumAmount = c.items.reduce((s,it)=> s + Number(it.amount||0), 0);
  const sumTax = c.items.reduce((s,it)=> s + Number(it.tax||0), 0);
  const depParts = Number(val('depParts')||0), depPaint = Number(val('depPaint')||0),
        depGlass = Number(val('depGlass')||0), depFibre = Number(val('depFibre')||0);
  const depTotal = c.items.reduce((s,it)=>{
    const pct = ({ part:depParts, paint:depPaint, glass:depGlass, fibre:depFibre, labour:0, consumable:0 })[it.type]||0;
    return s + (it.amount * pct/100);
  }, 0);
  const sumAdmissible = c.items.reduce((s,it)=> s + Number(it.admissible||0), 0);

  document.getElementById('sumAmount').textContent = fmt(sumAmount);
  document.getElementById('sumTax').textContent = fmt(sumTax);
  document.getElementById('sumAdmissible').textContent = fmt(sumAdmissible);

  const betterment = Number(val('betterment')||0);
  const excess = Number(val('excess')||0);
  const salvage = Number(val('salvage')||0);
  const nonAdm = Number(val('nonAdmissible')||0);

  document.getElementById('totalAdmissible').value = fmt(sumAdmissible);
  document.getElementById('depreciationTotal').value = fmt(depTotal);

  const net = sumAdmissible - depTotal - betterment - excess - salvage - nonAdm;
  document.getElementById('netAssessed').value = fmt(net);
  document.getElementById('netAssessedFooter').value = fmt(net);
  const diff = Number(val('billAmount')||0) - net;
  document.getElementById('differenceFooter').value = fmt(diff);
}

/* --- New: Parts & Labour dynamic tables and calculations --- */

function renderPartsTable(rows) {
  // rows = array of {type,desc,qty,rate,gst,depPct,depAmt,admissible}
  const tbody = els.partsTableBody;
  tbody.innerHTML = '';
  const data = rows || [];
  // ensure stored in claim
  const claim = getClaim(currentClaimId);
  if (claim) claim.assessment = claim.assessment || {};
  if (claim) claim.assessment.parts = data;
  data.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <select class="form-select form-select-sm" onchange="partsUpdate(${idx}, 'type', this.value)">
          <option value="metal" ${r.type==='metal'?'selected':''}>Metal</option>
          <option value="plastic" ${r.type==='plastic'?'selected':''}>Plastic</option>
          <option value="paint" ${r.type==='paint'?'selected':''}>Paint</option>
          <option value="glass" ${r.type==='glass'?'selected':''}>Glass</option>
          <option value="fibre" ${r.type==='fibre'?'selected':''}>Fibre</option>
          <option value="consumable" ${r.type==='consumable'?'selected':''}>Consumable</option>
        </select>
      </td>
      <td><input class="form-control form-control-sm" value="${escapeHtml(r.desc||'')}" onchange="partsUpdate(${idx}, 'desc', this.value)"></td>
      <td><input type="number" class="form-control form-control-sm" value="${r.qty||1}" onchange="partsUpdate(${idx}, 'qty', Number(this.value||0))"></td>
      <td><input type="number" class="form-control form-control-sm" value="${r.rate||0}" onchange="partsUpdate(${idx}, 'rate', Number(this.value||0))"></td>
      <td class="text-end">${fmt(Number(r.qty||0) * Number(r.rate||0))}</td>
      <td><input type="number" class="form-control form-control-sm" value="${r.gst||18}" onchange="partsUpdate(${idx}, 'gst', Number(this.value||0))"></td>
      <td class="text-end">${fmt(r.depPct||0)}</td>
      <td class="text-end">${fmt(r.depAmt||0)}</td>
      <td class="text-end">${fmt(r.admissible||0)}</td>
      <td class="text-center"><button class="btn btn-sm btn-outline-danger" onclick="removePart(${idx})"><i class="bi bi-x-lg"></i></button></td>
    `;
    tbody.appendChild(tr);
  });
  recomputeAssessment();
}

function addPartRow(){
  const claim = getClaim(currentClaimId);
  claim.assessment = claim.assessment || {};
  claim.assessment.parts = claim.assessment.parts || [];
  claim.assessment.parts.push({ type:'metal', desc:'', qty:1, rate:0, gst:18, depPct:0, depAmt:0, admissible:0 });
  saveDb();
  renderPartsTable(claim.assessment.parts);
}
function removePart(idx){
  const claim = getClaim(currentClaimId);
  claim.assessment.parts.splice(idx,1);
  saveDb(); renderPartsTable(claim.assessment.parts);
}
function clearParts(){
  const claim = getClaim(currentClaimId);
  claim.assessment.parts = [];
  saveDb(); renderPartsTable([]);
}

function partsUpdate(i, field, value){
  const claim = getClaim(currentClaimId);
  const rows = claim.assessment.parts;
  const r = rows[i];
  r[field] = value;
  // recompute money values
  const amount = Number(r.qty||0) * Number(r.rate||0);
  r.amount = amount;
  // depPct applied in recomputeAssessment according to mode and age
  saveDb();
  recomputeAssessment();
}

/* Labour table */
function renderLabourTable(rows) {
  const tbody = els.labourTableBody;
  tbody.innerHTML = '';
  const data = rows || [];
  const claim = getClaim(currentClaimId);
  if (claim) claim.assessment = claim.assessment || {};
  if (claim) claim.assessment.labour = data;
  data.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <select class="form-select form-select-sm" onchange="labUpdate(${idx}, 'type', this.value)">
          <option value="denting" ${r.type==='denting'?'selected':''}>Denting</option>
          <option value="painting" ${r.type==='painting'?'selected':''}>Painting</option>
          <option value="mechanical" ${r.type==='mechanical'?'selected':''}>Mechanical</option>
          <option value="electrical" ${r.type==='electrical'?'selected':''}>Electrical</option>
          <option value="towing" ${r.type==='towing'?'selected':''}>Towing</option>
          <option value="other" ${r.type==='other'?'selected':''}>Other</option>
        </select>
      </td>
      <td><input class="form-control form-control-sm" value="${escapeHtml(r.desc||'')}" onchange="labUpdate(${idx}, 'desc', this.value)"></td>
      <td><input type="number" class="form-control form-control-sm" value="${r.qty||1}" onchange="labUpdate(${idx}, 'qty', Number(this.value||0))"></td>
      <td><input type="number" class="form-control form-control-sm" value="${r.rate||0}" onchange="labUpdate(${idx}, 'rate', Number(this.value||0))"></td>
      <td class="text-end">${fmt(Number(r.qty||0) * Number(r.rate||0))}</td>
      <td><input type="number" class="form-control form-control-sm" value="${r.gst||18}" onchange="labUpdate(${idx}, 'gst', Number(this.value||0))"></td>
      <td class="text-end">${fmt(r.admissible||0)}</td>
      <td class="text-center"><button class="btn btn-sm btn-outline-danger" onclick="removeLabour(${idx})"><i class="bi bi-x-lg"></i></button></td>
    `;
    tbody.appendChild(tr);
  });
  recomputeAssessment();
}

function addLabRow(){
  const claim = getClaim(currentClaimId);
  claim.assessment = claim.assessment || {};
  claim.assessment.labour = claim.assessment.labour || [];
  claim.assessment.labour.push({ type:'denting', desc:'', qty:1, rate:0, gst:18, admissible:0 });
  saveDb();
  renderLabourTable(claim.assessment.labour);
}
function removeLabour(idx){
  const claim = getClaim(currentClaimId);
  claim.assessment.labour.splice(idx,1);
  saveDb(); renderLabourTable(claim.assessment.labour);
}
function clearLabour(){
  const claim = getClaim(currentClaimId);
  claim.assessment.labour = [];
  saveDb(); renderLabourTable([]);
}
function labUpdate(i, field, value){
  const claim = getClaim(currentClaimId);
  const rows = claim.assessment.labour;
  const r = rows[i];
  r[field] = value;
  r.amount = Number(r.qty||0) * Number(r.rate||0);
  r.admissible = r.amount + (r.amount * Number(r.gst||0) / 100);
  saveDb();
  recomputeAssessment();
}

/* Read back tables for saving */
function readPartsTable(){
  const claim = getClaim(currentClaimId);
  return (claim.assessment.parts || []).map(r => ({
    type: r.type, desc: r.desc, qty: Number(r.qty||0), rate: Number(r.rate||0), gst: Number(r.gst||0),
    amount: Number(r.amount||0), depPct: Number(r.depPct||0), depAmt: Number(r.depAmt||0), admissible: Number(r.admissible||0)
  }));
}
function readLabourTable(){
  const claim = getClaim(currentClaimId);
  return (claim.assessment.labour || []).map(r => ({
    type: r.type, desc: r.desc, qty: Number(r.qty||0), rate: Number(r.rate||0), gst: Number(r.gst||0),
    amount: Number(r.amount||0), admissible: Number(r.admissible||0)
  }));
}

/* --- Core: recomputeAssessment uses IRDA logic and modes --- */
function recomputeAssessment(){
  const c = getClaim(currentClaimId);
  if (!c) return;
  c.assessment = c.assessment || {};
  const depMode = c.assessment.depMode || document.querySelector('input[name="depMode"]:checked')?.value || 'irda';
  c.assessment.depMode = depMode;
  const addDep = Number(c.assessment.addDepPct || Number(val('addDepPct')||0));
  // determine vehicle age in months using dateDelivery or regValidTo as best available
  const regDate = c.vehicle.dateDelivery || c.vehicle.regValidTo || c.vehicle.regDate || '';
  const lossDate = c.loss.lossDate || val('lossDate') || '';
  const ageMonths = vehicleAgeMonthsFromDates(regDate, lossDate);
  // display age
  document.getElementById('vehAge').textContent = ageMonths === null ? '--' : `${Math.floor(ageMonths/12)}y ${Math.round(ageMonths%12)}m`;

  // compute parts
  const parts = c.assessment.parts || [];
  let parts_sumAmount = 0, parts_sumDep = 0, parts_sumAdm = 0, parts_depPctSum = 0;
  for (let r of parts) {
    r.amount = Number(r.qty||0) * Number(r.rate||0);
    // determine base dep%
    let baseDep = 0;
    if (depMode === 'nil') {
      baseDep = 0;
    } else if (depMode === 'zero') {
      baseDep = 0;
    } else {
      // IRDA mode: metal uses age-based table; others use admin defaults
      if (r.type === 'metal') baseDep = metalDepByAgeMonths(ageMonths);
      else if (r.type === 'plastic') baseDep = Number(document.getElementById('adminDepParts')?.value || db.admin.dep.parts);
      else if (r.type === 'paint') baseDep = Number(document.getElementById('adminDepPaint')?.value || db.admin.dep.paint);
      else if (r.type === 'glass') baseDep = Number(document.getElementById('adminDepGlass')?.value || db.admin.dep.glass);
      else if (r.type === 'fibre') baseDep = Number(document.getElementById('adminDepFibre')?.value || db.admin.dep.fibre);
      else baseDep = Number(document.getElementById('adminDepParts')?.value || db.admin.dep.parts);
    }
    // apply addDep
    const depPct = Math.max(0, baseDep + addDep + (Number(r.depAdj||0) || 0));
    r.depPct = Number(depPct.toFixed(2));
    r.depAmt = Number((r.amount * r.depPct/100).toFixed(2));
    const gstAmt = Number((r.amount * Number(r.gst||0) / 100).toFixed(2));
    // admissible: amount less depreciation + gst
    r.admissible = Number(Math.max(0, r.amount - r.depAmt) + gstAmt).toFixed(2) * 1;
    parts_sumAmount += r.amount;
    parts_sumDep += r.depAmt;
    parts_sumAdm += Number(r.admissible||0);
    parts_depPctSum += r.depPct;
  }

  // compute labour
  const labour = c.assessment.labour || [];
  let lab_sumAmount = 0, lab_sumTax = 0, lab_sumAdm = 0;
  for (let l of labour) {
    l.amount = Number(l.qty||0) * Number(l.rate||0);
    const gstAmt = Number((l.amount * Number(l.gst||0) / 100).toFixed(2));
    l.admissible = Number(l.amount + gstAmt).toFixed(2) * 1;
    lab_sumAmount += l.amount;
    lab_sumTax += gstAmt;
    lab_sumAdm += Number(l.admissible||0);
  }

  // write summary to UI
  document.getElementById('parts_sumAmount').textContent = fmt(parts_sumAmount);
  document.getElementById('parts_sumDep').textContent = fmt(parts_sumDep);
  document.getElementById('parts_sumAdm').textContent = fmt(parts_sumAdm);
  document.getElementById('parts_avgDepPct').textContent = parts.length ? fmt(parts_depPctSum/parts.length) : '0';

  document.getElementById('lab_sumAmount').textContent = fmt(lab_sumAmount);
  document.getElementById('lab_sumTax').textContent = fmt(lab_sumTax);
  document.getElementById('lab_sumAdm').textContent = fmt(lab_sumAdm);

  // totals and final net
  const totalAdmissible = Number(parts_sumAdm) + Number(lab_sumAdm);
  const depreciationTotal = Number(parts_sumDep);
  const betterment = Number(val('betterment')||0);
  const excess = Number(val('excess')||0);
  const salvage = Number(val('salvage')||0);
  const nonAdm = Number(val('nonAdmissible')||0);
  const netAssessed = Number((totalAdmissible - depreciationTotal - betterment - excess - salvage - nonAdm).toFixed(2));

  document.getElementById('totalAdmissible').value = fmt(totalAdmissible);
  document.getElementById('depreciationTotal').value = fmt(depreciationTotal);
  document.getElementById('netAssessed').value = fmt(netAssessed);

  // footer sync
  document.getElementById('netAssessedFooter').value = fmt(netAssessed);
  const bill = Number(val('billAmount')||0);
  document.getElementById('differenceFooter').value = fmt(bill - netAssessed);

  // persist computed values back to claim
  c.assessment.totalAdmissible = totalAdmissible;
  c.assessment.depreciationTotal = depreciationTotal;
  c.assessment.netAssessed = netAssessed;
  saveDb();

  // refresh parts and labour rows to show updated dep/admissible
  // (re-render to update displayed cells)
  renderPartsTable(c.assessment.parts || []);
  renderLabourTable(c.assessment.labour || []);
}

/* Reinspection (unchanged) */
function renderReinsp(list){
  const tbody = document.querySelector('#tblReinsp tbody');
  tbody.innerHTML = (list||[]).map((r,i)=> `
    <tr>
      <td><input type="date" class="form-control form-control-sm" value="${r.date||''}" onchange="updateReinsp(${i}, 'date', this.value)"></td>
      <td><input class="form-control form-control-sm" value="${escapeHtml(r.reason||'')}" onchange="updateReinsp(${i}, 'reason', this.value)"></td>
      <td><input class="form-control form-control-sm" value="${escapeHtml(r.findings||'')}" onchange="updateReinsp(${i}, 'findings', this.value)"></td>
      <td>
        ${(r.photos||[]).map((p,pi)=> `<span class="badge bg-light text-dark me-1">${p.name}</span>`).join('')}
        <button class="btn btn-sm btn-outline-secondary" onclick="addReinspPhoto(${i})"><i class="bi bi-paperclip"></i></button>
      </td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="removeReinsp(${i})"><i class="bi bi-x-lg"></i></button></td>
    </tr>
  `).join('');
}
function addReinsp(){
  const c = getClaim(currentClaimId);
  c.reinspections.push({ date: today(), reason:'', findings:'', photos:[] });
  saveDb(); renderReinsp(c.reinspections);
}
function clearReinsp(){
  const c = getClaim(currentClaimId);
  c.reinspections = [];
  saveDb(); renderReinsp(c.reinspections);
}
function updateReinsp(i, field, value){
  const c = getClaim(currentClaimId);
  c.reinspections[i][field] = value;
  saveDb(); renderReinsp(c.reinspections);
}
function removeReinsp(i){
  const c = getClaim(currentClaimId);
  c.reinspections.splice(i,1);
  saveDb(); renderReinsp(c.reinspections);
}
function addReinspPhoto(i){
  const name = prompt('Photo name (stub):');
  if (!name) return;
  const c = getClaim(currentClaimId);
  c.reinspections[i].photos.push({ name });
  saveDb(); renderReinsp(c.reinspections);
}

/* Uploads (unchanged) */
function renderUploads(list){
  els.uploadList.innerHTML = (list||[]).map((f,i)=> `
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <div><i class="bi bi-file-earmark"></i> ${f.name} <span class="small-muted">(${(f.size/1024/1024).toFixed(2)} MB)</span></div>
      <button class="btn btn-sm btn-outline-danger" onclick="removeUpload(${i})"><i class="bi bi-x-lg"></i></button>
    </li>
  `).join('');
}
function addUploads(files){
  const c = getClaim(currentClaimId);
  const arr = Array.from(files);
  for (const f of arr) {
    const ext = (f.name.split('.').pop()||'').toLowerCase();
    if (!['pdf','jpg','jpeg','png'].includes(ext)) { alert('Only PDF/JPG/PNG allowed'); continue; }
    if (f.size > 20*1024*1024) { alert('File exceeds 20 MB'); continue; }
    if ((c.uploads||[]).length >= 50) { alert('Max 50 files per claim'); break; }
    c.uploads.push({ name:f.name, size:f.size, type:f.type });
  }
  saveDb(); renderUploads(c.uploads);
}
function removeUpload(i){
  const c = getClaim(currentClaimId);
  c.uploads.splice(i,1);
  saveDb(); renderUploads(c.uploads);
}

/* Actions copy/scan/upload/report (unchanged except ensure assessment recalc) */
function copyPeriod(){ setVal('tpFrom', val('odFrom')); setVal('tpTo', val('odTo')); }
function copyInsuredToOwner(){ setVal('ownerName', val('insuredName')); }
function scanRcStub(){ alert('RC scan is a stub in this demo.'); }
function uploadStub(id){ alert('Upload to insurer portal is a stub in this demo.'); }

function generateReport(){
  // Save first to ensure latest values
  saveClaim();
  const c = getClaim(currentClaimId);
  const tpl = db.admin.reportTemplate;
  const map = {
    refNo: c.policy.refNo||'', claimNo: c.policy.claimNo||'', policyNo: c.policy.policyNo||'',
    insuredTitle: c.policy.insuredTitle||'', insuredName: c.policy.insuredName||'', insurer: c.policy.insurer||'',
    vehReg: c.vehicle.vehReg||'', make: c.vehicle.make||'', model: c.vehicle.model||'', year: c.vehicle.year||'',
    lossDate: c.loss.lossDate||'', lossTime: c.loss.lossTime||'', lossPlace: c.loss.lossPlace||'', lossCause: c.loss.lossCause||'',
    totalAdmissible: fmt(c.assessment.totalAdmissible||document.getElementById('totalAdmissible').value),
    depreciationTotal: fmt(c.assessment.depreciationTotal||document.getElementById('depreciationTotal').value),
    betterment: fmt(c.assessment.betterment||val('betterment')),
    excess: fmt(c.assessment.excess||val('excess')),
    salvage: fmt(c.assessment.salvage||val('salvage')),
    netAssessed: fmt(c.assessment.netAssessed||document.getElementById('netAssessed').value),
    assessmentRemarks: c.assessment.remarks||'',
    generatedOn: new Date().toLocaleString()
  };
  let html = tpl;
  Object.keys(map).forEach(k=> { html = html.replaceAll(`{{${k}}}`, map[k]); });
  els.printContent.innerHTML = html;
  window.setTimeout(()=> window.print(), 150);
}
function printClaim(id){
  openClaim(id);
  // ensure recompute before print
  recomputeAssessment();
  generateReport(); // print report view
}

/* Event wiring (preserve) */
document.getElementById('btnNewClaim').addEventListener('click', newClaim);
document.getElementById('btnApplyFilters').addEventListener('click', renderList);
document.getElementById('btnClearFilters').addEventListener('click', ()=>{
  ['fltStatus','fltInsurer','fltDateFrom','fltDateTo','fltVeh','fltText'].forEach(id=> setVal(id,''));
  renderList();
});
document.querySelectorAll('.tile').forEach(t=> t.addEventListener('click',()=>{ setVal('fltStatus', t.dataset.status); renderList(); }));

document.getElementById('btnBack').addEventListener('click', ()=>{ document.getElementById('claimEditor').style.display = 'none'; });
document.getElementById('btnSave').addEventListener('click', ()=> { saveClaim(); alert('Saved'); });
document.getElementById('btnGenerate').addEventListener('click', ()=> { const c=getClaim(currentClaimId); c.status='Generated'; saveClaim(); renderTiles(); alert('Report marked Generated'); });
document.getElementById('btnPrint').addEventListener('click', ()=> { recomputeAssessment(); generateReport(); });
document.getElementById('btnUpload').addEventListener('click', ()=> uploadStub(currentClaimId));

document.getElementById('btnCopyPeriod').addEventListener('click', copyPeriod);
document.getElementById('btnCopyInsured').addEventListener('click', copyInsuredToOwner);
document.getElementById('btnScanRc').addEventListener('click', scanRcStub);

document.getElementById('btnAddItem').addEventListener('click', addItem);
document.getElementById('btnClearItems').addEventListener('click', clearItems);

document.getElementById('btnAddReinsp').addEventListener('click', addReinsp);
document.getElementById('btnClearReinsp').addEventListener('click', clearReinsp);

els.fileUpload.addEventListener('change', e=> addUploads(e.target.files));

document.getElementById('btnAdmin').addEventListener('click', ()=>{ const ap = document.getElementById('adminPanel'); const ce = document.getElementById('claimEditor'); ce.style.display = 'none'; ap.style.display = ap.style.display==='none' ? 'block' : 'none'; });

document.getElementById('btnAddInsurer').addEventListener('click', ()=>{ const v = document.getElementById('newInsurer').value.trim(); if (!v) return; db.admin.insurers.push(v); saveDb(); document.getElementById('newInsurer').value=''; renderAdminLists(); });
document.getElementById('btnAddWorkshop').addEventListener('click', ()=>{ const v = document.getElementById('newWorkshop').value.trim(); if (!v) return; db.admin.workshops.push(v); saveDb(); document.getElementById('newWorkshop').value=''; renderAdminLists(); });
document.getElementById('btnAddChecklistItem').addEventListener('click', ()=>{ const v = document.getElementById('newChecklistItem').value.trim(); if (!v) return; db.admin.checklist.push(v); saveDb(); document.getElementById('newChecklistItem').value=''; renderAdminLists(); });
document.getElementById('btnSaveAdmin').addEventListener('click', ()=>{ db.admin.dep.parts = Number(document.getElementById('adminDepParts').value||0); db.admin.dep.paint = Number(document.getElementById('adminDepPaint').value||0); db.admin.dep.glass = Number(document.getElementById('adminDepGlass').value||0); db.admin.dep.fibre = Number(document.getElementById('adminDepFibre').value||0); db.admin.dep.excess = Number(document.getElementById('adminExcess').value||0); db.admin.reportTemplate = document.getElementById('reportTemplate').value || defaults.reportTemplate; saveDb(); ensureDepToFields(); renderTiles(); alert('Admin settings saved'); });
document.getElementById('btnResetAdmin').addEventListener('click', ()=>{ if (!confirm('Reset admin to defaults?')) return; db.admin = {}; initAdminDefaults(); renderAdminLists(); ensureDepToFields(); });

document.getElementById('addPartRow').addEventListener('click', addPartRow);
document.getElementById('clearParts').addEventListener('click', clearParts);
document.getElementById('addLabRow').addEventListener('click', addLabRow);
document.getElementById('clearLabour').addEventListener('click', clearLabour);
document.getElementById('applyAddDep').addEventListener('click', ()=>{ const c = getClaim(currentClaimId); if (!c) return; c.assessment = c.assessment || {}; c.assessment.addDepPct = Number(val('addDepPct')||0); saveDb(); recomputeAssessment(); alert('Add Dep applied'); });

/* Hook date changes to recompute assessment */
document.getElementById('lossDate').addEventListener('change', ()=> { recomputeAssessment(); });
document.getElementById('dateDelivery').addEventListener('change', ()=> { recomputeAssessment(); });

/* File upload in docs */
els.fileUpload.addEventListener('change', (e) => { addUploads(e.target.files); e.target.value = ''; });

/* Initialize */
initAdminDefaults();
renderAdminLists();
renderTiles();
renderList();

/* Expose for onclick HTML */
window.openClaim = openClaim;
window.printClaim = printClaim;
window.uploadStub = uploadStub;
window.updateItem = updateItem;
window.removeItem = removeItem;
window.addReinspPhoto = addReinspPhoto;
window.removeUpload = removeUpload;
window.partsUpdate = partsUpdate;
window.removePart = removePart;
window.labUpdate = labUpdate;
window.removeLabour = removeLabour;
window.renderPartsTable = renderPartsTable;
window.renderLabourTable = renderLabourTable;

/* small helpers */
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

</script>
</body>
</html>
